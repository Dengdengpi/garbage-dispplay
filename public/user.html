<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Smart‚ÄëBin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    /* Reuse same background & card styles */
    #gradientBG{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#ff0080,#ff8c00,#40c8ff,#ff40ff);background-size:600% 600%;animation:swirl 15s ease infinite;opacity:.6;z-index:-10000}
    #starfield,#starRain{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-9999}
    canvas{position:absolute;width:100%;height:100%}
    .fall{position:absolute;color:#fff;font-size:1rem;animation:fall 4s linear infinite}
    @keyframes fall{0%{transform:translateY(-20px);opacity:1}100%{transform:translateY(110vh);opacity:0}}
    @keyframes swirl{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body{margin:0;padding:1rem;font-family:Arial,sans-serif;background:transparent;color:#fff;overflow-x:hidden}
    h1{text-align:center;margin-bottom:1rem;text-shadow:0 0 10px #fff}
    #controls{text-align:center;margin-bottom:1rem;display:flex;gap:1rem;justify-content:center}
    #controls button{padding:.5rem 1rem;border:1px solid #fff;background:rgba(255,255,255,.1);color:#fff;border-radius:4px;cursor:pointer;transition:.3s}
    #controls button:hover{background:rgba(255,255,255,.3)}
    #feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .card{background:rgba(0,0,0,0.6);border-radius:8px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 4px 12px rgba(0,0,0,.5);transition:transform .2s}
    .card:hover{transform:scale(1.02)}
    .card img{width:100%;height:auto;object-fit:cover}
    .title{text-align:center;font-weight:bold;padding:.6rem 1rem;border-bottom:1px solid rgba(255,255,255,.2)}
    .comments{flex-grow:1;padding:.8rem 1rem;font-size:.9rem;line-height:1.3;color:#ddd}
    .time{text-align:right;font-size:.75rem;padding:.5rem 1rem;color:#ccc}
    #toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.5rem 1rem;border-radius:4px;opacity:0;transition:opacity .3s;pointer-events:none}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <div id="gradientBG"></div>
  <div id="starfield">
    <canvas id="sf1"></canvas>
    <canvas id="sf2"></canvas>
    <canvas id="sf3"></canvas>
    <canvas id="sf4"></canvas>
  </div>
  <div id="starRain"></div>

  <h1>Smart‚ÄëBin</h1>
  <div id="controls">
    <button id="shoot">üì∏¬†Take Picture</button>
    <button id="clearMe">üóëÔ∏è¬†Clear My History</button>
  </div>
  <div id="feed">Loading‚Ä¶</div>
  <div id="toast"></div>

  <script>
    // Starfield & rain scripts (same as above)
    ['sf1','sf2','sf3','sf4'].forEach((id,i)=>{
      const c=document.getElementById(id), ctx=c.getContext('2d');
      function resize(){c.width=innerWidth; c.height=innerHeight;}
      window.addEventListener('resize',resize); resize();
      const stars=[...Array(200+i*40)].map(()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.5,s:0.3+i*0.3+Math.random()*0.4}));
      (function draw(){ctx.clearRect(0,0,c.width,c.height);ctx.fillStyle='#fff';stars.forEach(s=>{s.y+=s.s;if(s.y>c.height)s.y=0;ctx.fillRect(s.x,s.y,s.r,s.r)});requestAnimationFrame(draw)})();
    });
    setInterval(()=>{if(Math.random()<.6){const sp=document.createElement('span');sp.className='fall';sp.textContent='‚ú¶';sp.style.left=Math.random()*innerWidth+'px';document.getElementById('starRain').append(sp);setTimeout(()=>sp.remove(),4000)}},500);

    // UID + Toast
    const uid=localStorage.uid||crypto.randomUUID(); localStorage.uid=uid;
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1500)}

    // Build card
    function makeCard(rec){
      const parts=rec.report.split('\n');
      let [cat,obj]=parts[0].split(';').map(s=>s.trim());
      const title=`${obj}¬†‚Äì¬†${cat}`;
      const [c1,c2]=[parts[1]||'',parts[2]||''];
      const time=new Date(rec.ts).toLocaleString();
      return `
        <div class="card">
          <img src="data:image/jpeg;base64,${rec.b64}">
          <div class="title">${title}</div>
          <div class="comments"><p>${c1}</p><p>${c2}</p></div>
          <div class="time">${time}</div>
        </div>`;
    }

    // Load feed
    async function loadFeed(){
      const r=await fetch(`/api/records?uid=${uid}`), data=await r.json();
      const feed=document.getElementById('feed'); feed.innerHTML='';
      if(!data.length){feed.textContent='No history yet.';return;}
      data.forEach(rec=>feed.insertAdjacentHTML('beforeend',makeCard(rec)));
    }
    loadFeed(); setInterval(loadFeed,5000);

    // Buttons
    document.getElementById('shoot').onclick=async()=>{
      showToast('Capturing‚Ä¶');
      await fetch(`/trigger?uid=${uid}`);
      showToast('Captured!');
    };
    document.getElementById('clearMe').onclick=async()=>{
      if(!confirm('Delete your history?'))return;
      await fetch(`/clear-user?uid=${uid}`,{method:'POST'});
      showToast('Cleared');
      loadFeed();
    };
  </script>
</body>
</html>
